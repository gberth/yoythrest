globalThis.IMBA_MANIFEST={"entry:src/app/yoythrest.imba?web":{"url":"./assets/yoythrest.ZUEHCHJ7.js","path":"/home/gunnar/yoyth/yoythrest/dist/public/assets/yoythrest.ZUEHCHJ7.js"},"*?css":{"url":"./assets/index.VW9NQJUX.css","path":"/home/gunnar/yoyth/yoythrest/dist/public/assets/index.VW9NQJUX.css"},"./assets/yoythrest.ZUEHCHJ7.js":{},"./assets/yoythrest.3LJQXUBT.css":{},"./assets/index.VW9NQJUX.css":{}};globalThis.IMBA_ASSETS_PATH='assets'
var Ae=Object.create;var ne=Object.defineProperty;var Me=Object.getOwnPropertyDescriptor;var Ee=Object.getOwnPropertyNames;var Pe=Object.getPrototypeOf,je=Object.prototype.hasOwnProperty;var De=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Ee(e))!je.call(t,o)&&o!==r&&ne(t,o,{get:()=>e[o],enumerable:!(n=Me(e,o))||n.enumerable});return t};var y=(t,e,r)=>(r=t!=null?Ae(Pe(t)):{},De(e||!t||!t.__esModule?ne(r,"default",{value:t,enumerable:!0}):r,t));var w=Symbol.for("#__init__"),Ye=Symbol.for("#__initor__");var Be=Symbol.for("#meta"),N=Symbol.for("imba");var at={SUPERCALLS:1<<3,CONSTRUCTOR:1<<4},P={IsExtension:1<<0,IsTag:1<<1,HasDescriptors:1<<2,HasSuperCalls:1<<3,HasConstructor:1<<4,HasFields:1<<5,HasMixins:1<<6,HasInitor:1<<7,HasDecorators:1<<8,IsObjectExtension:1<<9},S=new Map,Fe=globalThis[N]||(globalThis[N]={counter:0,classes:S});function b(t,e={}){var r;return S.has(t)||S.set(t,{symbol:Symbol(),parent:(r=Object.getPrototypeOf(t.prototype))==null?void 0:r.constructor,for:t,uses:[],inits:[],id:Fe.counter++,...e}),S.get(t)}function U(t){var e;return((e=t==null?void 0:t.toIterable)==null?void 0:e.call(t))||t}function Ne(t,e){if(!t||!e)return!1;if(t.get)return e.get===t.get;if(t.set)return e.set===t.set;if(t.value)return t.value===e.value}function oe(t,e,r){let n=t.constructor;r??(r=Object.getOwnPropertyDescriptors(e));let o=Object.getOwnPropertyDescriptors(t);delete r.constructor,r[w]&&delete r[w],Object.defineProperties(t,r);let i=b(n);if(i&&i.augments)for(let a of i.augments){let s=Object.getOwnPropertyDescriptors(a.prototype),l={};for(let p of Object.keys(r)){let c=r[p];s[p]&&!Ne(o[p],s[p])?console.warn("wont extend",p):l[p]=c}Object.keys(l).length&&oe(a.prototype,null,l)}return t}function se(t,e){let r=b(t),n=b(e);if(n.parent&&!(t.prototype instanceof n.parent))throw new Error(`Mixin ${e.name} has superclass not present in target class`);if(!n.augments){n.augments=new Set;let i=n.ref=Symbol(),a=Object[Symbol.hasInstance];e.prototype[i]=!0,Object.defineProperty(e,Symbol.hasInstance,{value:function(s){return this===e?s&&!!s[i]:a.call(this,s)}})}if(t.prototype[n.ref])return t;for(let i of n.uses)se(t,i,r);n.augments.add(t),r.uses.push(e);let o=Object.getOwnPropertyDescriptors(e.prototype);delete o.constructor,o[w]&&(r.inits.push(e.prototype[w]),delete o[w]),Object.defineProperties(t.prototype,o);try{r.top.version++}catch{}return t}var _={cache:{},self:null,target:null,proxy:new Proxy({},{apply:(t,e,...r)=>_.target[e].apply(_.self,r),get:(t,e)=>Reflect.get(_.target,e,_.self),set:(t,e,r,n)=>Reflect.set(_.target,e,r,_.self)})};function f(t,e,r,n,o=null){var p,c;let i=Object.getPrototypeOf(t.prototype);if(n&P.HasMixins&&(S.set(t,S.get(i.constructor)),i=Object.getPrototypeOf(i)),o){let u=n&P.IsObjectExtension?o:o.prototype,v=b(t);if((p=v.uses)!=null&&p.length){o===u&&console.warn("Cannot extend object with mixins");for(let E of v.uses)se(o,E)}return n&P.HasSuperCalls&&(_.cache[e]=Object.create(Object.getPrototypeOf(u),Object.getOwnPropertyDescriptors(u))),oe(u,t.prototype),o}let s=i==null?void 0:i.constructor,l=b(t,{symbol:e});if(Object.defineProperty(t,Be,{value:l,enumerable:!1,configurable:!0}),r&&t.name!==r&&Object.defineProperty(t,"name",{value:r,configurable:!0}),l.flags=n,n&P.HasConstructor&&(t.prototype[Ye]=e),l.uses)for(let u of l.uses)(c=u.mixes)==null||c.call(u,t);return(s==null?void 0:s.inherited)instanceof Function&&s.inherited(t),t}var ft=require("cluster"),h=y(require("fs")),x=y(require("path")),ce=require("events");var q=y(require("path")),Ue=Symbol(),O,ie=new(O=class{get rootDir(){return process.env.IMBA_OUTDIR||q.default.dirname(process.env.pm_exec_path||process.argv[1])}get publicPath(){return q.default.resolve(this.rootDir,process.env.IMBA_PUBDIR||globalThis.IMBA_PUBDIR||"public")}},(()=>{f(O,Ue,"Env",0)})(),O);var pe=y(require("http")),mt=require("https");function d(t){let e;return t&&((e=t.toIterable)?e.call(t):t)}function le(t,e){var r;return typeof e=="string"?typeof t===e:(r=e[Symbol.hasInstance])==null?void 0:r.call(e,t)}var qe=Symbol.for("#setup"),ae=Symbol.for("#setup?"),Le=Symbol.for("#dom"),We=Symbol.for("#server"),ue={html:{"Content-Type":"text/html; charset=utf-8"},js:{"Content-Type":"text/javascript; charset=utf-8"},cjs:{"Content-Type":"text/javascript; charset=utf-8"},mjs:{"Content-Type":"text/javascript; charset=utf-8"},json:{"Content-Type":"application/json; charset=utf-8"},css:{"Content-Type":"text/css; charset=utf-8"},map:{"Content-Type":"application/json; charset=utf-8"},otf:{"Content-Type":"font/otf"},ttf:{"Content-Type":"font/ttf"},woff:{"Content-Type":"font/woff"},woff2:{"Content-Type":"font/woff2"},svg:{"Content-Type":"image/svg+xml"},avif:{"Content-Type":"image/avif"},gif:{"Content-Type":"image/gif"},png:{"Content-Type":"image/png"},apng:{"Content-Type":"image/apng"},webp:{"Content-Type":"image/webp"},jpg:{"Content-Type":"image/jpeg"},jpeg:{"Content-Type":"image/jpeg"},ico:{"Content-Type":"image/x-icon"},bmp:{"Content-Type":"image/bmp"},pdf:{"Content-Type":"application/pdf"},webm:{"Content-Type":"video/webm"},weba:{"Content-Type":"audio/webm"},avi:{"Content-Type":"video/x-msvideo"},mp3:{"Content-Type":"audio/mpeg"},mp4:{"Content-Type":"video/mp4"},m4a:{"Content-Type":"audio/m4a"},mov:{"Content-Type":"video/quicktime"},wmv:{"Content-Type":"video/x-ms-wmv"},mpeg:{"Content-Type":"video/mpeg"},wav:{"Content-Type":"audio/wav"},ogg:{"Content-Type":"audio/ogg"},ogv:{"Content-Type":"video/ogg"},oga:{"Content-Type":"audio/ogg"},opus:{"Content-Type":"audio/opus"}},g=globalThis.process,Je=Symbol(),K=class extends Set{call(e,...r){var n;n=[];for(let o of d(this))n.push(o[e](...r));return n}close(e={}){var r;r=[];for(let n of d(this))r.push(n.close(e));return r}reload(e={}){var r;r=[];for(let n of d(this))r.push(n.reload(e));return r}broadcast(e,...r){var n;n=[];for(let o of d(this))n.push(o.broadcast(e,...r));return n}emit(e,r){var n;n=[];for(let o of d(this))n.push(o.emit(e,r));return n}},L=K;(()=>{f(K,Je,"Servers",0)})();var C=new L,Ke=Symbol(),I,gt=new(I=class extends ce.EventEmitter{constructor(){var e;super(...arguments),e=this,this.autoreload=!1,this.state={}}[qe](){var e=this;if(this[ae]!=!0&&(this[ae]=!0,!0))return this.on("rebuild",function(r){let n=globalThis.IMBA_MANIFEST;return globalThis.IMBA_MANIFEST=r,C.broadcast("rebuild",r)}),this.on("reloading",function(r){var n;e.state.reloading=!0,n=[];for(let o of d(C))n.push(o.pause());return n}),this.on("reloaded",async function(r){var n;e.state.reloaded=!0,C.broadcast("reloaded"),await new Promise(function(i){return setTimeout(i,100)}),n=[];for(let i of d(C))n.push(i.close());let o=n;return setTimeout(function(){return g.exit(0)},100),await Promise.all(o),g.exit(0)}),!0}send(e){if(le(g.send,Function))return g.send(e)}on(e,r){return super.on(...arguments)}reload(){if(!(this.isReloading!=!0&&(this.isReloading=!0,!0)))return this;if(this.state.reloading=!0,!g.env.IMBA_SERVE){console.warn("not possible to gracefully reload servers not started via imba start");return}this.send("reload")}},(()=>{f(I,Ke,"Process",24)})(),I);function fe(t,e=[],r=0){let n=globalThis.IMBA_MANIFEST[t];if(e.indexOf(t)>=0)return e;if(n!=null&&n.imports)for(let o=0,i=d(n==null?void 0:n.imports),a=i.length;o<a;o++){let s=i[o];e.push(s),fe(s,e,r+1)}return e}var Ve=Symbol(),V=class{constructor(e,r,n={}){this.server=e,this.url=r,[this.pathname,this.query]=r.split("?"),this.ext=x.default.extname(this.pathname),this.headers={"Content-Type":"text/plain","Access-Control-Allow-Origin":"*","cache-control":"public, max-age=31536000"},Object.assign(this.headers,e.options.assetHeaders||{}),Object.assign(this.headers,ue[this.ext.slice(1)]||{}),this.headers["max-age"]=864e5,n.imports&&e.options.preload!==!1&&(this.headers.Link=fe(r).map(function(o){return"<"+o+">; rel=modulepreload; as=script"}).join(", ")),this.path=e.localPathForUrl(r)}respond(e,r){var n=this;return h.default.access(this.path,h.default.constants.R_OK,function(o){if(o)return r.writeHead(404,{}),r.end();try{if(n.server.options.setHeaders&&n.server.options.setHeaders(r,n.path),globalThis.BUN)return h.default.readFile(n.path,function(i,a){return r.writeHead(200,n.headers),r.end(a)});{let i=h.default.createReadStream(n.path);return r.writeHead(200,n.headers),i.pipe(r)}}catch{return r.writeHead(503,{}),r.end()}})}createReadStream(){return h.default.createReadStream(this.path)}pipe(e){return this.createReadStream().pipe(e)}},W=V;(()=>{f(V,Ve,"AssetResponder",16)})();var Ze=Symbol(),Z=class{static wrap(e,r={}){return new this(e,r)}localPathForUrl(e){var i;let r,n,o=e.replace(/\?.*$/,"");return(i=this.urlToLocalPathMap)[o]??(i[o]=(r=x.default.resolve(ie.publicPath,"."+o),n=h.default.existsSync(r)&&r,!n&&this.staticDir&&(r=x.default.resolve(this.staticDir,"."+o),n=h.default.existsSync(r)&&r),n))}headersForAsset(e){let r,n=x.default.extname(e);return r=Object.assign({"Content-Type":"text/plain","Access-Control-Allow-Origin":"*","cache-control":"public"},ue[n.slice(1)]||{})}get manifest(){return globalThis.IMBA_MANIFEST||{}}constructor(e,r={}){var n=this;C.add(this),this.id=Math.random(),this.options=r,this.closed=!1,this.paused=!1,this.server=e,this.clients=new Set,this.stalledResponses=[],this.assetResponders={},this.urlToLocalPathMap={},this.publicExistsMap={},this.staticDir=globalThis.IMBA_STATICDIR||"",g.env.IMBA_PATH&&(this.devtoolsPath=x.default.resolve(g.env.IMBA_PATH,"hmr.js")),this.scheme=le(e,pe.default.Server)?"http":"https";let o=this.server._events.request,i=globalThis[Le];e.off("request",o),o[We]=this,e.on("listening",function(){let a=n.server.address(),s=a.address;(s=="::"||s=="0.0.0.0")&&(s="localhost");let l=""+n.scheme+"://"+s+":"+a.port+"/";if(!g.env.IMBA_CLUSTER)return console.log("listening on "+l)}),this.handler=function(a,s){var re;let l,p=a.constructor.name=="Http2ServerRequest",c=a.url;if(n.paused||n.closed)return s.statusCode=302,s.setHeader("Location",a.url),p||s.setHeader("Connection","close"),n.closed?(p&&a.stream.session.close(),s.end()):n.stalledResponses.push(s);let u=a.headers,v;p?v=u[":scheme"]+"://"+u[":authority"]:v=(a.connection.encrypted?"https":"http")+"://"+u.host;let E=n.manifest[c];if(E&&n.localPathForUrl(c))return((re=n.assetResponders)[c]||(re[c]=new W(n,c,E))).respond(a,s);if((c.match(/\.[A-Z\d]{8}\./)||c.match(/\.\w{1,4}($|\?)/))&&(l=n.localPathForUrl(c)))try{let m=n.headersForAsset(l);if(r.setHeaders&&r.setHeaders(s,l),globalThis.BUN)return h.default.readFile(l,function($,He){return $?(s.writeHead(500,{}),s.write("Error getting the file: "+$)):(s.writeHead(200,m),s.end(He))});{let $=h.default.createReadStream(l);return s.writeHead(200,m),$.pipe(s)}}catch{return s.writeHead(503,{}),s.end()}if(i){let m=new i.Location(a.url,v);return i.Document.create({location:m},function(){return o(a,s)})}else return o(a,s)},e.on("request",this.handler),e.on("close",function(){return console.log("server is closing!!!")})}broadcast(e,r={},n=this.clients){r=JSON.stringify(r);let o="data: "+r+`


`;for(let i of d(n))i.write("event: "+e+`
`),i.write(`id: imba
`),i.write(o);return this}pause(){return this.paused!=!0&&(this.paused=!0,!0)&&this.broadcast("paused"),this}resume(){if(this.paused!=!1&&(this.paused=!1,!0))return this.broadcast("resumed"),this.flushStalledResponses()}flushStalledResponses(){for(let e=0,r=d(this.stalledResponses),n=r.length;e<n;e++)r[e].end();return this.stalledResponses=[]}close(){var e=this;return this.pause(),new Promise(function(r){return e.closed=!0,e.server.close(r),e.flushStalledResponses()})}},J=Z;(()=>{f(Z,Ze,"Server",16)})();function de(t,...e){return J.wrap(t,...e)}var be=require("node:crypto");var te=y(require("express")),jt=require("path");var he=y(require("fs"));function ze(t){let e;return t&&((e=t.toIterable)?e.call(t):t)}function Ge(t,e){var r;return typeof e=="string"?typeof t===e:(r=e[Symbol.hasInstance])==null?void 0:r.call(e,t)}function Qe(t,e,r=[""]){for(let n=0,o=ze(r),i=o.length;n<i;n++){let a=o[n],s=t.indexOf(a);if(s>=0)return t.slice(0,s)+e+t.slice(s)}return t}var Xe=Symbol(),G=class{constructor(e){this.src=e}get entry(){var e;return(e=globalThis.IMBA_MANIFEST)==null?void 0:e[this.src]}get url(){return this.entry?this.entry.url:this.src}get path(){return this.entry?this.entry.path:null}get body(){return this.path?he.default.readFileSync(this.path,"utf-8"):null}toString(){return this.url}},j=G;(()=>{f(G,Xe,"ImbaAsset",16)})();function D(t){var r;let e;return(e=(r=globalThis.IMBA_MANIFEST)==null?void 0:r[t])?new j(t):t}var ke=Symbol(),Q=class{constructor(e,r){this.text=e,this.refs=r}get body(){var e=this;let r=this.text.replace(/ASSET_REF_(\d+)/g,function(n,o){var s;let i,a=e.refs[o];return Ge(a,j)?String(a):(i=(s=globalThis.IMBA_MANIFEST)==null?void 0:s[String(a)])?i.url:a});return globalThis.IMBA_HMR_PATH&&(r=Qe(r,"<script src='/__hmr__.js'><\/script>",["<!--$head$-->","<!--$body$-->","<html",""])),r}toString(){return this.body}},z=Q;(()=>{f(Q,ke,"HtmlAsset",16)})();function me(t,e){return new z(t,e)}var ye=D("*?css");var ge=D("entry:src/app/yoythrest.imba?web");var et=[ye,ge],_e=me(`<html lang="en">

<head><!--$head$-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:100,200,300" rel="stylesheet" />

    <title>Yoyth Connect</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <!-- reference to the client script styles -->
    <link rel='stylesheet' href='ASSET_REF_0'>
</head>

<body><!--$body$-->
    <!-- reference to the client script -->
    <script type="module" src='ASSET_REF_1'><\/script>
</body>

</html>`,et);var Oe=y(require("fs"));var tt=y(require("moment"));function X(t){if(t&&t.message_data)return t.message_data.type}function Te(t){return t.message_data.type==="ACK"}function k(t){return t.message_data.original.type}function ve(t){return t.message_data.request_data&&t.message_data.request_data.requestType&&t.message_data.request_data.requestType!="ERROR"}var rt=require("ws"),M=(0,te.default)(),nt=process.env.PORT||3e3,T,B=!1,R=!1,Se,H=0,xe=0,F=0,ot=!1,Y=[];function A(t){if(!B&&t){Y.push(t);return}if(Y.length>0){for(let e=0,r=U(Y),n=r.length;e<n;e++){let o=r[e];console.dir(o),T.send(JSON.stringify(o))}Y=[]}if(t)return console.dir(t),T.send(JSON.stringify(t))}function st(t,e){let r;return t.startsWith("---")||t.startsWith("ssh")?r=t:r=Oe.default.readFileSync(process.env[t]||t).toString("utf-8"),(0,be.publicEncrypt)(r,Buffer.from(e,"utf-8"))}var ee={message_data:{type:"server_login",creator:"yoythrest",request_data:{stream_id:"yoythrest"}},identity_data:{identity:process.env.YOYTHRESTID},payload:{yoyth_login_identity:process.env.YOYTHRESTID,yoyth_login_name:process.env.YOYTHAPP,yoyth_secret:st(process.env.YOYTHIDSPUBLICKEY,process.env.YOYTHSECRET),yoyth_ids_public_key:process.env.YOYTHSECRET}},Ce={message_data:{type:"ping",creator:"yoythrest",request_data:{stream_id:"yoythrest"},original:{type:"ping"}},identity_data:{identity:process.env.YOYTHRESTID},payload:{}},$e={message_data:{type:"vipps_access_request",creator:"yoythrest",request_data:{stream_id:"rest_web_server"}},identity_data:{identity:process.env.YOYTHRESTID,from_identity:process.env.YOYTHRESTID,to_identity:process.env.YOYTHIDSIDENTITY},payload:{query:{}}};console.dir(ee);function Ie(){return console.log(process.env.YOYTHWSADDRESS),T=new rt(process.env.YOYTHWSADDRESS),T.on("open",function(){return B=!0,console.log("open"),A(void 0)}),T.on("message",function(t){console.log(t);let e=JSON.parse(t);if(console.log(e),H=0,e.connection_id){if(Se&&!e.reidentify){console.log("send back"),A({connection_id:e.connection_id,reconnect_id:Se,identity:process.env.YOYTHRESTID});return}if(e.reconnected){console.log("reconnected"),R=!0;return}A(ee)}if(e.message_data)if(Te(e)){if(k(e)===X(ee))return ve(e)?(R=!0,xe=0,console.log("connect to identity server ok")):(console.error("connect to identity server failed"),xe+=1,R=!1);if(k(e)===X(Ce))return F-=1,console.log("ping ok")}else return console.log("what msg?"),console.dir(e)}),T.on("close",function(t){return console.error("close"),console.dir(t),H+=1,R=!1,B=!1,we()}),T.on("error",function(t){return H+=1,console.log("error"),console.dir(t),R=!1,B=!1,we()})}function we(){return setTimeout(function(){return console.log("waited! errors="+H),H>10&&(console.log("restart server"),ot=!0,process.exit(12)),console.log("try to establish connection"),Ie()},1e3)}function Re(){return F+=1,A(Ce),setTimeout(function(){if(console.log("Send ping if outstanding pings < 3: "+F),F>=3){console.log("restart server"),process.exit(12);return}return Re()},15e3)}Ie();Re();var Ft=te.default.json({limit:"1kb"});M.post("/justtesting",function(t,e){return console.dir(t),console.dir("body"),console.dir(t.body),e.send({body:t.body})});M.get("/yts",function(t,e){return console.log("ytsrequest"),console.dir(t.body),console.dir(t.query),e.send(),$e.payload.query=t.query,A($e)});M.get("/yoythrest/apiadmin/ping",function(t,e){return e.send({ping:"OK"})});M.get(/.*/,function(t,e){return t.accepts(["image/*","html"])!="html"?e.sendStatus(404):e.send(_e.body)});de(M.listen(nt));
//__FOOT__
