globalThis.IMBA_MANIFEST={"entry:src/app/yoythrest.imba?web":{"url":"./assets/yoythrest.ZUEHCHJ7.js","path":"/home/gunnar/yoyth/yoythrest/dist/public/assets/yoythrest.ZUEHCHJ7.js"},"*?css":{"url":"./assets/index.VW9NQJUX.css","path":"/home/gunnar/yoyth/yoythrest/dist/public/assets/index.VW9NQJUX.css"},"./assets/yoythrest.ZUEHCHJ7.js":{},"./assets/yoythrest.3LJQXUBT.css":{},"./assets/index.VW9NQJUX.css":{}};globalThis.IMBA_ASSETS_PATH='assets'
var He=Object.create;var oe=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var Me=Object.getOwnPropertyNames;var Ee=Object.getPrototypeOf,Pe=Object.prototype.hasOwnProperty;var je=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Me(e))!Pe.call(t,o)&&o!==r&&oe(t,o,{get:()=>e[o],enumerable:!(n=Ae(e,o))||n.enumerable});return t};var g=(t,e,r)=>(r=t!=null?He(Ee(t)):{},je(e||!t||!t.__esModule?oe(r,"default",{value:t,enumerable:!0}):r,t));var O=Symbol.for("#__init__"),De=Symbol.for("#__initor__");var Ye=Symbol.for("#meta"),B=Symbol.for("imba");var st={SUPERCALLS:1<<3,CONSTRUCTOR:1<<4},j={IsExtension:1<<0,IsTag:1<<1,HasDescriptors:1<<2,HasSuperCalls:1<<3,HasConstructor:1<<4,HasFields:1<<5,HasMixins:1<<6,HasInitor:1<<7,HasDecorators:1<<8,IsObjectExtension:1<<9},x=new Map,Be=globalThis[B]||(globalThis[B]={counter:0,classes:x});function b(t,e={}){var r;return x.has(t)||x.set(t,{symbol:Symbol(),parent:(r=Object.getPrototypeOf(t.prototype))==null?void 0:r.constructor,for:t,uses:[],inits:[],id:Be.counter++,...e}),x.get(t)}function F(t){var e;return((e=t==null?void 0:t.toIterable)==null?void 0:e.call(t))||t}function Fe(t,e){if(!t||!e)return!1;if(t.get)return e.get===t.get;if(t.set)return e.set===t.set;if(t.value)return t.value===e.value}function se(t,e,r){let n=t.constructor;r??(r=Object.getOwnPropertyDescriptors(e));let o=Object.getOwnPropertyDescriptors(t);delete r.constructor,r[O]&&delete r[O],Object.defineProperties(t,r);let s=b(n);if(s&&s.augments)for(let a of s.augments){let i=Object.getOwnPropertyDescriptors(a.prototype),l={};for(let u of Object.keys(r)){let p=r[u];i[u]&&!Fe(o[u],i[u])?console.warn("wont extend",u):l[u]=p}Object.keys(l).length&&se(a.prototype,null,l)}return t}function ie(t,e){let r=b(t),n=b(e);if(n.parent&&!(t.prototype instanceof n.parent))throw new Error(`Mixin ${e.name} has superclass not present in target class`);if(!n.augments){n.augments=new Set;let s=n.ref=Symbol(),a=Object[Symbol.hasInstance];e.prototype[s]=!0,Object.defineProperty(e,Symbol.hasInstance,{value:function(i){return this===e?i&&!!i[s]:a.call(this,i)}})}if(t.prototype[n.ref])return t;for(let s of n.uses)ie(t,s,r);n.augments.add(t),r.uses.push(e);let o=Object.getOwnPropertyDescriptors(e.prototype);delete o.constructor,o[O]&&(r.inits.push(e.prototype[O]),delete o[O]),Object.defineProperties(t.prototype,o);try{r.top.version++}catch{}return t}var S={cache:{},self:null,target:null,proxy:new Proxy({},{apply:(t,e,...r)=>S.target[e].apply(S.self,r),get:(t,e)=>Reflect.get(S.target,e,S.self),set:(t,e,r,n)=>Reflect.set(S.target,e,r,S.self)})};function d(t,e,r,n,o=null){var u,p;let s=Object.getPrototypeOf(t.prototype);if(n&j.HasMixins&&(x.set(t,x.get(s.constructor)),s=Object.getPrototypeOf(s)),o){let f=n&j.IsObjectExtension?o:o.prototype,v=b(t);if((u=v.uses)!=null&&u.length){o===f&&console.warn("Cannot extend object with mixins");for(let P of v.uses)ie(o,P)}return n&j.HasSuperCalls&&(S.cache[e]=Object.create(Object.getPrototypeOf(f),Object.getOwnPropertyDescriptors(f))),se(f,t.prototype),o}let i=s==null?void 0:s.constructor,l=b(t,{symbol:e});if(Object.defineProperty(t,Ye,{value:l,enumerable:!1,configurable:!0}),r&&t.name!==r&&Object.defineProperty(t,"name",{value:r,configurable:!0}),l.flags=n,n&j.HasConstructor&&(t.prototype[De]=e),l.uses)for(let f of l.uses)(p=f.mixes)==null||p.call(f,t);return(i==null?void 0:i.inherited)instanceof Function&&i.inherited(t),t}var pt=require("cluster"),m=g(require("fs")),$=g(require("path")),pe=require("events");var N=g(require("path")),Ne=Symbol(),C,ae=new(C=class{get rootDir(){return process.env.IMBA_OUTDIR||N.default.dirname(process.env.pm_exec_path||process.argv[1])}get publicPath(){return N.default.resolve(this.rootDir,process.env.IMBA_PUBDIR||globalThis.IMBA_PUBDIR||"public")}},(()=>{d(C,Ne,"Env",0)})(),C);var ue=g(require("http")),dt=require("https");function h(t){let e;return t&&((e=t.toIterable)?e.call(t):t)}function ce(t,e){var r;return typeof e=="string"?typeof t===e:(r=e[Symbol.hasInstance])==null?void 0:r.call(e,t)}var Ue=Symbol.for("#setup"),le=Symbol.for("#setup?"),qe=Symbol.for("#dom"),Le=Symbol.for("#server"),fe={html:{"Content-Type":"text/html; charset=utf-8"},js:{"Content-Type":"text/javascript; charset=utf-8"},cjs:{"Content-Type":"text/javascript; charset=utf-8"},mjs:{"Content-Type":"text/javascript; charset=utf-8"},json:{"Content-Type":"application/json; charset=utf-8"},css:{"Content-Type":"text/css; charset=utf-8"},map:{"Content-Type":"application/json; charset=utf-8"},otf:{"Content-Type":"font/otf"},ttf:{"Content-Type":"font/ttf"},woff:{"Content-Type":"font/woff"},woff2:{"Content-Type":"font/woff2"},svg:{"Content-Type":"image/svg+xml"},avif:{"Content-Type":"image/avif"},gif:{"Content-Type":"image/gif"},png:{"Content-Type":"image/png"},apng:{"Content-Type":"image/apng"},webp:{"Content-Type":"image/webp"},jpg:{"Content-Type":"image/jpeg"},jpeg:{"Content-Type":"image/jpeg"},ico:{"Content-Type":"image/x-icon"},bmp:{"Content-Type":"image/bmp"},pdf:{"Content-Type":"application/pdf"},webm:{"Content-Type":"video/webm"},weba:{"Content-Type":"audio/webm"},avi:{"Content-Type":"video/x-msvideo"},mp3:{"Content-Type":"audio/mpeg"},mp4:{"Content-Type":"video/mp4"},m4a:{"Content-Type":"audio/m4a"},mov:{"Content-Type":"video/quicktime"},wmv:{"Content-Type":"video/x-ms-wmv"},mpeg:{"Content-Type":"video/mpeg"},wav:{"Content-Type":"audio/wav"},ogg:{"Content-Type":"audio/ogg"},ogv:{"Content-Type":"video/ogg"},oga:{"Content-Type":"audio/ogg"},opus:{"Content-Type":"audio/opus"}},_=globalThis.process,We=Symbol(),W=class extends Set{call(e,...r){var n;n=[];for(let o of h(this))n.push(o[e](...r));return n}close(e={}){var r;r=[];for(let n of h(this))r.push(n.close(e));return r}reload(e={}){var r;r=[];for(let n of h(this))r.push(n.reload(e));return r}broadcast(e,...r){var n;n=[];for(let o of h(this))n.push(o.broadcast(e,...r));return n}emit(e,r){var n;n=[];for(let o of h(this))n.push(o.emit(e,r));return n}},U=W;(()=>{d(W,We,"Servers",0)})();var I=new U,Je=Symbol(),R,mt=new(R=class extends pe.EventEmitter{constructor(){var e;super(...arguments),e=this,this.autoreload=!1,this.state={}}[Ue](){var e=this;if(this[le]!=!0&&(this[le]=!0,!0))return this.on("rebuild",function(r){let n=globalThis.IMBA_MANIFEST;return globalThis.IMBA_MANIFEST=r,I.broadcast("rebuild",r)}),this.on("reloading",function(r){var n;e.state.reloading=!0,n=[];for(let o of h(I))n.push(o.pause());return n}),this.on("reloaded",async function(r){var n;e.state.reloaded=!0,I.broadcast("reloaded"),await new Promise(function(s){return setTimeout(s,100)}),n=[];for(let s of h(I))n.push(s.close());let o=n;return setTimeout(function(){return _.exit(0)},100),await Promise.all(o),_.exit(0)}),!0}send(e){if(ce(_.send,Function))return _.send(e)}on(e,r){return super.on(...arguments)}reload(){if(!(this.isReloading!=!0&&(this.isReloading=!0,!0)))return this;if(this.state.reloading=!0,!_.env.IMBA_SERVE){console.warn("not possible to gracefully reload servers not started via imba start");return}this.send("reload")}},(()=>{d(R,Je,"Process",24)})(),R);function de(t,e=[],r=0){let n=globalThis.IMBA_MANIFEST[t];if(e.indexOf(t)>=0)return e;if(n!=null&&n.imports)for(let o=0,s=h(n==null?void 0:n.imports),a=s.length;o<a;o++){let i=s[o];e.push(i),de(i,e,r+1)}return e}var Ke=Symbol(),J=class{constructor(e,r,n={}){this.server=e,this.url=r,[this.pathname,this.query]=r.split("?"),this.ext=$.default.extname(this.pathname),this.headers={"Content-Type":"text/plain","Access-Control-Allow-Origin":"*","cache-control":"public, max-age=31536000"},Object.assign(this.headers,e.options.assetHeaders||{}),Object.assign(this.headers,fe[this.ext.slice(1)]||{}),this.headers["max-age"]=864e5,n.imports&&e.options.preload!==!1&&(this.headers.Link=de(r).map(function(o){return"<"+o+">; rel=modulepreload; as=script"}).join(", ")),this.path=e.localPathForUrl(r)}respond(e,r){var n=this;return m.default.access(this.path,m.default.constants.R_OK,function(o){if(o)return r.writeHead(404,{}),r.end();try{if(n.server.options.setHeaders&&n.server.options.setHeaders(r,n.path),globalThis.BUN)return m.default.readFile(n.path,function(s,a){return r.writeHead(200,n.headers),r.end(a)});{let s=m.default.createReadStream(n.path);return r.writeHead(200,n.headers),s.pipe(r)}}catch{return r.writeHead(503,{}),r.end()}})}createReadStream(){return m.default.createReadStream(this.path)}pipe(e){return this.createReadStream().pipe(e)}},q=J;(()=>{d(J,Ke,"AssetResponder",16)})();var Ve=Symbol(),K=class{static wrap(e,r={}){return new this(e,r)}localPathForUrl(e){var s;let r,n,o=e.replace(/\?.*$/,"");return(s=this.urlToLocalPathMap)[o]??(s[o]=(r=$.default.resolve(ae.publicPath,"."+o),n=m.default.existsSync(r)&&r,!n&&this.staticDir&&(r=$.default.resolve(this.staticDir,"."+o),n=m.default.existsSync(r)&&r),n))}headersForAsset(e){let r,n=$.default.extname(e);return r=Object.assign({"Content-Type":"text/plain","Access-Control-Allow-Origin":"*","cache-control":"public"},fe[n.slice(1)]||{})}get manifest(){return globalThis.IMBA_MANIFEST||{}}constructor(e,r={}){var n=this;I.add(this),this.id=Math.random(),this.options=r,this.closed=!1,this.paused=!1,this.server=e,this.clients=new Set,this.stalledResponses=[],this.assetResponders={},this.urlToLocalPathMap={},this.publicExistsMap={},this.staticDir=globalThis.IMBA_STATICDIR||"",_.env.IMBA_PATH&&(this.devtoolsPath=$.default.resolve(_.env.IMBA_PATH,"hmr.js")),this.scheme=ce(e,ue.default.Server)?"http":"https";let o=this.server._events.request,s=globalThis[qe];e.off("request",o),o[Le]=this,e.on("listening",function(){let a=n.server.address(),i=a.address;(i=="::"||i=="0.0.0.0")&&(i="localhost");let l=""+n.scheme+"://"+i+":"+a.port+"/";if(!_.env.IMBA_CLUSTER)return console.log("listening on "+l)}),this.handler=function(a,i){var ne;let l,u=a.constructor.name=="Http2ServerRequest",p=a.url;if(n.paused||n.closed)return i.statusCode=302,i.setHeader("Location",a.url),u||i.setHeader("Connection","close"),n.closed?(u&&a.stream.session.close(),i.end()):n.stalledResponses.push(i);let f=a.headers,v;u?v=f[":scheme"]+"://"+f[":authority"]:v=(a.connection.encrypted?"https":"http")+"://"+f.host;let P=n.manifest[p];if(P&&n.localPathForUrl(p))return((ne=n.assetResponders)[p]||(ne[p]=new q(n,p,P))).respond(a,i);if((p.match(/\.[A-Z\d]{8}\./)||p.match(/\.\w{1,4}($|\?)/))&&(l=n.localPathForUrl(p)))try{let y=n.headersForAsset(l);if(r.setHeaders&&r.setHeaders(i,l),globalThis.BUN)return m.default.readFile(l,function(w,Re){return w?(i.writeHead(500,{}),i.write("Error getting the file: "+w)):(i.writeHead(200,y),i.end(Re))});{let w=m.default.createReadStream(l);return i.writeHead(200,y),w.pipe(i)}}catch{return i.writeHead(503,{}),i.end()}if(s){let y=new s.Location(a.url,v);return s.Document.create({location:y},function(){return o(a,i)})}else return o(a,i)},e.on("request",this.handler),e.on("close",function(){return console.log("server is closing!!!")})}broadcast(e,r={},n=this.clients){r=JSON.stringify(r);let o="data: "+r+`


`;for(let s of h(n))s.write("event: "+e+`
`),s.write(`id: imba
`),s.write(o);return this}pause(){return this.paused!=!0&&(this.paused=!0,!0)&&this.broadcast("paused"),this}resume(){if(this.paused!=!1&&(this.paused=!1,!0))return this.broadcast("resumed"),this.flushStalledResponses()}flushStalledResponses(){for(let e=0,r=h(this.stalledResponses),n=r.length;e<n;e++)r[e].end();return this.stalledResponses=[]}close(){var e=this;return this.pause(),new Promise(function(r){return e.closed=!0,e.server.close(r),e.flushStalledResponses()})}},L=K;(()=>{d(K,Ve,"Server",16)})();function he(t,...e){return L.wrap(t,...e)}var Oe=require("node:crypto");var re=g(require("express")),Et=require("path");var me=g(require("fs"));function Ze(t){let e;return t&&((e=t.toIterable)?e.call(t):t)}function Ge(t,e){var r;return typeof e=="string"?typeof t===e:(r=e[Symbol.hasInstance])==null?void 0:r.call(e,t)}function ze(t,e,r=[""]){for(let n=0,o=Ze(r),s=o.length;n<s;n++){let a=o[n],i=t.indexOf(a);if(i>=0)return t.slice(0,i)+e+t.slice(i)}return t}var Qe=Symbol(),Z=class{constructor(e){this.src=e}get entry(){var e;return(e=globalThis.IMBA_MANIFEST)==null?void 0:e[this.src]}get url(){return this.entry?this.entry.url:this.src}get path(){return this.entry?this.entry.path:null}get body(){return this.path?me.default.readFileSync(this.path,"utf-8"):null}toString(){return this.url}},D=Z;(()=>{d(Z,Qe,"ImbaAsset",16)})();function Y(t){var r;let e;return(e=(r=globalThis.IMBA_MANIFEST)==null?void 0:r[t])?new D(t):t}var Xe=Symbol(),G=class{constructor(e,r){this.text=e,this.refs=r}get body(){var e=this;let r=this.text.replace(/ASSET_REF_(\d+)/g,function(n,o){var i;let s,a=e.refs[o];return Ge(a,D)?String(a):(s=(i=globalThis.IMBA_MANIFEST)==null?void 0:i[String(a)])?s.url:a});return globalThis.IMBA_HMR_PATH&&(r=ze(r,"<script src='/__hmr__.js'><\/script>",["<!--$head$-->","<!--$body$-->","<html",""])),r}toString(){return this.body}},V=G;(()=>{d(G,Xe,"HtmlAsset",16)})();function ye(t,e){return new V(t,e)}var ge=Y("*?css");var _e=Y("entry:src/app/yoythrest.imba?web");var ke=[ge,_e],Te=ye(`<html lang="en">

<head><!--$head$-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:100,200,300" rel="stylesheet" />

    <title>Yoyth Connect</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <!-- reference to the client script styles -->
    <link rel='stylesheet' href='ASSET_REF_0'>
</head>

<body><!--$body$-->
    <!-- reference to the client script -->
    <script type="module" src='ASSET_REF_1'><\/script>
</body>

</html>`,ke);var be=g(require("fs"));var et=g(require("moment"));function z(t){if(t&&t.message_data)return t.message_data.type}function Se(t){return t.message_data.type==="ACK"}function Q(t){return t.message_data.original.type}function ve(t){return t.message_data.request_data&&t.message_data.request_data.requestType&&t.message_data.request_data.requestType!="ERROR"}var A=require("ws"),E=(0,re.default)(),tt=process.env.PORT||3e3,c,T=!1,xe,X=0,$e=0,k=0;var H=[];function rt(t=!1){if(c&&c.readyState===A.OPEN&&(T||t))return!0;if(console.error("ws status? "+c.readyState+" connected "+T),c){if(!c.readyState===A.OPEN)return T=!1,!c.readyState===A.CONNECTING&&te(),!1}else te();return!1}function M(t,e=!1){if(!rt(e)){console.error("waiting "+H.length),t&&H.push(t);return}if(H.length>0){for(let r=0,n=F(H),o=n.length;r<o;r++){let s=n[r];console.dir(s),c.send(JSON.stringify(s))}H=[]}if(t)return console.dir(t),c.send(JSON.stringify(t))}function Ce(){return k+=1,M(Ie,!1),setTimeout(function(){if(console.log("Send ping if outstanding pings <=4 : "+k),c&&c.readyState===A.OPEN)return Ce()},15e3)}function nt(t,e){let r;return t.startsWith("---")||t.startsWith("ssh")?r=t:r=be.default.readFileSync(process.env[t]||t).toString("utf-8"),(0,Oe.publicEncrypt)(r,Buffer.from(e,"utf-8"))}var ee={message_data:{type:"server_login",creator:"yoythrest",request_data:{stream_id:"yoythrest"}},identity_data:{identity:process.env.YOYTHRESTID},payload:{yoyth_login_identity:process.env.YOYTHRESTID,yoyth_login_name:process.env.YOYTHAPP,yoyth_secret:nt(process.env.YOYTHIDSPUBLICKEY,process.env.YOYTHSECRET),yoyth_ids_public_key:process.env.YOYTHSECRET}},Ie={message_data:{type:"ping",creator:"yoythrest",request_data:{stream_id:"yoythrest"},original:{type:"ping"}},identity_data:{identity:process.env.YOYTHRESTID},payload:{}},we={message_data:{type:"vipps_access_request",creator:"yoythrest",request_data:{stream_id:"rest_web_server"}},identity_data:{identity:process.env.YOYTHRESTID,from_identity:process.env.YOYTHRESTID,to_identity:process.env.YOYTHIDSIDENTITY},payload:{query:{}}};console.dir(ee);function te(){return console.log(process.env.YOYTHWSADDRESS),c=new A(process.env.YOYTHWSADDRESS),c.on("open",function(){return console.log("open"),M(void 0,!0),Ce()}),c.on("message",function(t){console.log(t);let e=JSON.parse(t);if(console.log(e),X=0,e.connection_id){if(xe&&!e.reidentify){console.log("send back"),M({connection_id:e.connection_id,reconnect_id:xe,identity:process.env.YOYTHRESTID},!0);return}if(e.reconnected){console.log("reconnected"),T=!0;return}M(ee,!0)}if(e.message_data)if(Se(e)){if(Q(e)===z(ee))return ve(e)?(T=!0,$e=0,console.log("connect to identity server ok")):(console.error("connect to identity server failed"),$e+=1,T=!1);if(Q(e)===z(Ie))return k-=1,console.log("ping ok")}else return console.log("what msg?"),console.dir(e)}),c.on("close",function(t){return console.error("close"),console.dir(t),X+=1,T=!1}),c.on("error",function(t){return X+=1,console.log("error"),console.dir(t),T=!1})}te();var Yt=re.default.json({limit:"1kb"});E.post("/justtesting",function(t,e){return console.dir(t),console.dir("body"),console.dir(t.body),e.send({body:t.body})});E.get("/yts",function(t,e){return console.log("ytsrequest"),console.dir(t.body),console.dir(t.query),e.send(),we.payload.query=t.query,M(we)});E.get("/yoythrest/apiadmin/ping",function(t,e){return e.send({ping:"OK"})});E.get(/.*/,function(t,e){return t.accepts(["image/*","html"])!="html"?e.sendStatus(404):e.send(Te.body)});he(E.listen(tt));
//__FOOT__
